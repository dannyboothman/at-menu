/*
 * At Menu
 * Copyright 2023 Daniel Boothman
 * www.atmenujs.com
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t(e)):"object"==typeof exports?module.exports=t(e):e.AtMenu=t(e)}("undefined"!=typeof global?global:this.window||this.global,(function(e){"use strict";var t=e,n={},o={target:"",menu:"",items:".atm-item",openMenu:"@",closeMenu:"Escape",marginTop:30},i=function(){var e={},t=!1,n=0,o=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(t=arguments[0],n++);for(var a=function(n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t&&"[object Object]"===Object.prototype.toString.call(n[o])?e[o]=i(!0,e[o],n[o]):e[o]=n[o])};n<o;n++){var r=arguments[n];a(r)}return e},a=function(e){e.menu.classList.remove("atm-menu-active"),null!=e.onClose&&AtMenu.onCloseRun(e)},r=function(e){var t=document.querySelector(".atm-item-active");if(t){var n=t.offsetTop;e.menu.scrollTo({top:n})}},l=function(e){var t=null;const n=e.target.value,o=n.indexOf(e.openMenu);if(o>=0){const i=e.target.selectionStart;t=n.substring(o+1,i)}return t},u=function(e,t,n){var o=document.querySelectorAll(t.items),i=!1;null!=document.querySelector(".atm-item-active")&&document.querySelector(".atm-item-active").classList.remove("atm-item-active");for(var a=0;a<o.length;a++){o[a].innerText.toLowerCase().includes(e.toLowerCase())?(o[a].classList.remove("atm-item-inactive"),0==i&&(i=!0,o[a].classList.add("atm-item-active"))):o[a].classList.add("atm-item-inactive")}0==i&&null!=document.querySelector(".atm-item-active")&&document.querySelector(".atm-item-active").classList.remove("atm-item-active"),r(t)};n.getCaretPosition=function(e){var t={caret:s(e.target),target:e.target.getBoundingClientRect(),menu:e.menu.getBoundingClientRect(),html:document.querySelector("html").scrollTop};return console.log(t),t};var s=function(e){const n=document.createElement("span");n.style.position="absolute",n.style.visibility="hidden",n.style.whiteSpace="pre",n.style.font=t.getComputedStyle(e,null).getPropertyValue("font"),n.style.fontSize=t.getComputedStyle(e,null).getPropertyValue("font-size"),n.style.padding=t.getComputedStyle(e,null).getPropertyValue("padding"),n.style.margin=t.getComputedStyle(e,null).getPropertyValue("margin"),n.style.boxSizing=t.getComputedStyle(e,null).getPropertyValue("box-sizing"),n.style.wordSpacing=t.getComputedStyle(e,null).getPropertyValue("word-spacing"),n.style.textTransform=t.getComputedStyle(e,null).getPropertyValue("text-transform"),n.style.direction=t.getComputedStyle(e,null).getPropertyValue("direction"),n.style.textIndent=t.getComputedStyle(e,null).getPropertyValue("text-indent"),n.style.lineHeight=t.getComputedStyle(e,null).getPropertyValue("line-height");const o=e.selectionStart,i=e.value.substring(0,o).split("\n"),a=i[i.length-1];n.textContent=a,document.body.appendChild(n);const r=n.offsetWidth;document.body.removeChild(n);const l=parseFloat(t.getComputedStyle(e,null).getPropertyValue("line-height")),u=parseFloat(t.getComputedStyle(e,null).getPropertyValue("font-size"));return{left:r,top:(i.length-1)*l+(l-u)/2}};n.onChooseRun=function(e,t){if("object"!=typeof(o=e)||null===o||Array.isArray(o)){e=c.find((t=>t.targetId==e));var n=t}else n=e.menu.querySelector(".atm-item-active");var o,i={settings:e,event:event,target:e.target,selectedItem:n,typedText:l(e),caretPos:this.getCaretPosition(e)};e.onChoose(i)},n.onOpenRun=function(e){var t={settings:e,event:event,target:e.target,typedText:l(e),caretPos:this.getCaretPosition(e)};e.onOpen(t)},n.onCloseRun=function(e){var t={settings:e,event:event,target:e.target,typedText:l(e),caretPos:this.getCaretPosition(e)};e.onClose(t)},n.onFilterRun=function(e){var t={settings:e,event:event,target:e.target,typedText:l(e),caretPos:this.getCaretPosition(e)};e.onFilter(t)},n.insertContent=function(e,t,n=!0){var o=e.settings,i=o.target.value;const r=i.indexOf(o.openMenu),l=o.target.selectionStart,u=`${t}`,s=i.substring(0,r)+u+i.substring(l);o.target.value=s,a(o);let c=o.target.value.indexOf(u);c+=u.length,o.target.focus(),o.target.setSelectionRange(c,c)};var c=new Array;return n.init=function(e){var t=i(o,e||{});t.targetId=e.target,t.menuId=e.menu,t.target=document.querySelector(e.target),t.menu=document.querySelector(e.menu),c.push(t),".atm-item"==t.items&&function(e){for(var t=e.menu.children,n=0;n<t.length;n++)t[n].classList.add("atm-item")}(t),null!=t.onChoose&&function(e){var t=document.querySelectorAll(e.items);[].forEach.call(t,(function(t){t.setAttribute("onclick","AtMenu.onChooseRun('"+e.targetId+"', this)")}))}(t),t.target.addEventListener("input",(function(e){!function(e,t){if(e.target.value[e.target.selectionStart-1]===e.openMenu){var n=AtMenu.getCaretPosition(e),i=o.marginTop;e.marginTop&&(i=e.marginTop),e.menu.style.top=n.caret.top+n.target.top+n.html+i+"px",e.menu.style.left=n.caret.left+n.target.left-30+"px",e.menu.classList.add("atm-menu-active"),null!=e.onOpen&&AtMenu.onOpenRun(e)}}(t),function(e,t){var n=l(e);null!=n&&(u(n,e,t),null!=e.onFilter&&n.length>0&&AtMenu.onFilterRun(e))}(t,e)}),!1),t.target.addEventListener("keydown",(function(e){t.menu.classList.contains("atm-menu-active")&&(function(e,t){t.code==e.closeMenu&&(e.menu.classList.remove("atm-menu-active"),null!=e.onClose&&AtMenu.onCloseRun(e))}(t,e),function(e,t){null!=e.onChoose&&(13!=t.keyCode&&"Enter"!=t.key&&"insertLineBreak"!=t.inputType||(t.preventDefault(),AtMenu.onChooseRun(e)))}(t,e),function(e,t){8!=t.keyCode&&"Backspace"!=t.key||e.target.value[e.target.selectionStart-1]===e.openMenu&&a(e)}(t,e),function(e,t){if(38==t.keyCode||"ArrowUp"==t.key){t.preventDefault();var n=document.querySelector(".atm-item-active");if(n){for(var o=n.previousElementSibling;o&&o.classList.contains("atm-item-inactive");)o=o.previousElementSibling;o&&(n.classList.remove("atm-item-active"),o.classList.add("atm-item-active"))}r(e)}}(t,e),function(e,t){if(40==t.keyCode||"ArrowDown"==t.key){t.preventDefault();var n=document.querySelector(".atm-item-active");if(n){for(var o=n.nextElementSibling;o&&o.classList.contains("atm-item-inactive");)o=o.nextElementSibling;o&&(n.classList.remove("atm-item-active"),o.classList.add("atm-item-active"))}r(e)}}(t,e))}),!1)},n}));