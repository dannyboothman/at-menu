/*
 * @ Menu
 * Copyright 2023 Daniel Boothman
 * www.atmenujs.com
 * License: MIT
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t(e)):"object"==typeof exports?module.exports=t(e):e.AtMenu=t(e)}("undefined"!=typeof global?global:this.window||this.global,(function(e){"use strict";var t=e,n={},o={target:"",menu:"",items:".atm-item",openMenu:"@",closeMenu:"Escape",marginTop:0},a=function(){var e={},t=!1,n=0,o=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(t=arguments[0],n++);for(var r=function(n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t&&"[object Object]"===Object.prototype.toString.call(n[o])?e[o]=a(!0,e[o],n[o]):e[o]=n[o])};n<o;n++){r(arguments[n])}return e},r=function(e){e.menu.classList.remove("atm-menu-active"),null!=e.onClose&&AtMenu.onCloseRun(e)},l=function(e){var t=document.querySelector(e.menuId+" .atm-item-active");if(t){var n=t.offsetTop;e.menu.scrollTo({top:n})}},i=function(e){var t=null;let n;"INPUT"==e.target.tagName||"TEXTAREA"==e.target.tagName?n=e.target.value:e.target.getAttribute("contenteditable")&&(n=e.target.innerText);let o=-1;if(Array.isArray(e.openMenu)){let t=0;for(;-1===o&&t<e.openMenu.length;){const a=e.openMenu[t];o=n.indexOf(a),t++}}else o=n.indexOf(e.openMenu);if(o>=0){let a;"INPUT"==e.target.tagName||"TEXTAREA"==e.target.tagName?a=e.target.selectionStart:e.target.getAttribute("contenteditable")&&(a=s(e.target)),t=n.substring(o+1,a)}return t},u=function(e,t,n){var o=document.querySelectorAll(t.menuId+" "+t.items),a=!1,r=document.querySelector(t.menuId+" .atm-item-active");null!=r&&r.classList.remove("atm-item-active");for(var i=0;i<o.length;i++){o[i].innerText.toLowerCase().includes(e.toLowerCase())?(o[i].classList.remove("atm-item-inactive"),0==a&&(a=!0,o[i].classList.add("atm-item-active"))):o[i].classList.add("atm-item-inactive")}0==a&&null!=r&&r.classList.remove("atm-item-active"),l(t)},s=function(e){let n=0;if(void 0!==t.getSelection){if(0!==t.getSelection().rangeCount){const o=t.getSelection().getRangeAt(0),a=o.cloneRange();a.selectNodeContents(e),a.setEnd(o.endContainer,o.endOffset),n=a.toString().length}}return n};n.getCaretPosition=function(e){return{caret:g(e.target),target:e.target.getBoundingClientRect(),menu:e.menu.getBoundingClientRect(),html:document.querySelector("html").scrollTop}};var g=function(e){const n=document.createElement("span");let o,a;n.style.position="absolute",n.style.visibility="hidden",n.style.whiteSpace="pre",n.style.font=t.getComputedStyle(e,null).getPropertyValue("font"),n.style.fontSize=t.getComputedStyle(e,null).getPropertyValue("font-size"),n.style.padding=t.getComputedStyle(e,null).getPropertyValue("padding"),n.style.margin=t.getComputedStyle(e,null).getPropertyValue("margin"),n.style.boxSizing=t.getComputedStyle(e,null).getPropertyValue("box-sizing"),n.style.wordSpacing=t.getComputedStyle(e,null).getPropertyValue("word-spacing"),n.style.textTransform=t.getComputedStyle(e,null).getPropertyValue("text-transform"),n.style.direction=t.getComputedStyle(e,null).getPropertyValue("direction"),n.style.textIndent=t.getComputedStyle(e,null).getPropertyValue("text-indent"),n.style.lineHeight=t.getComputedStyle(e,null).getPropertyValue("line-height"),n.style.border=t.getComputedStyle(e,null).getPropertyValue("border"),n.style.letterSpacing=t.getComputedStyle(e,null).getPropertyValue("letter-spacing"),n.style.fontWeight=t.getComputedStyle(e,null).getPropertyValue("font-weight"),n.style.fontStyle=t.getComputedStyle(e,null).getPropertyValue("font-style"),n.style.fontVariant=t.getComputedStyle(e,null).getPropertyValue("font-variant"),n.style.textDecoration=t.getComputedStyle(e,null).getPropertyValue("text-decoration"),n.style.top=t.getComputedStyle(e,null).getPropertyValue("top"),n.style.left=t.getComputedStyle(e,null).getPropertyValue("left"),n.style.height="auto",n.style.width="auto","INPUT"==e.tagName||"TEXTAREA"==e.tagName?(o=e.selectionStart,a=e.value.substring(0,o).split("\n")):e.getAttribute("contenteditable")&&(o=s(e),a=e.innerText.substring(0,o).split("\n"));const r=a[a.length-1];n.textContent=r,document.body.appendChild(n);const l=n.offsetWidth;document.body.removeChild(n);const i=parseFloat(t.getComputedStyle(e,null).getPropertyValue("line-height")),u=parseFloat(t.getComputedStyle(e,null).getPropertyValue("font-size"));return{left:l,top:(a.length-1)*i+i+u}};n.onChooseRun=function(e,t){if("object"!=typeof(o=e)||null===o||Array.isArray(o)){e=c.find((t=>t.targetId==e));var n=t}else n=e.menu.querySelector(".atm-item-active");var o,a={settings:e,event:event,target:e.target,selectedItem:n,typedText:i(e),caretPos:this.getCaretPosition(e)};e.onChoose(a)},n.onOpenRun=function(e){var t={settings:e,event:event,target:e.target,typedText:i(e),caretPos:this.getCaretPosition(e)};e.onOpen(t)},n.onCloseRun=function(e){var t={settings:e,event:event,target:e.target,typedText:i(e),caretPos:this.getCaretPosition(e)};e.onClose(t)},n.onFilterRun=function(e){var t={settings:e,event:event,target:e.target,typedText:i(e),caretPos:this.getCaretPosition(e)};e.onFilter(t)},n.insertContent=function(e,n,o=!0){var a=e.settings;let l,i;"INPUT"==a.target.tagName||"TEXTAREA"==a.target.tagName?(l=a.target.value,i=a.target.selectionStart):a.target.getAttribute("contenteditable")&&(l=a.target.innerText,i=s(a.target));let u=-1;if(Array.isArray(a.openMenu)){let e=0;for(;-1===u&&e<a.openMenu.length;){const t=a.openMenu[e];u=l.indexOf(t),e++}}else u=l.indexOf(a.openMenu);const g=`${n}`,c=i-u,m=l.substring(0,u)+g+l.substring(i);"INPUT"==a.target.tagName||"TEXTAREA"==a.target.tagName?a.target.value=m:a.target.innerText=m,r(a);let d=i-c+g.length;if(a.target.focus(),"INPUT"==a.target.tagName||"TEXTAREA"==a.target.tagName)a.target.setSelectionRange(d,d);else if(a.target.getAttribute("contenteditable")){var p=document.createRange();p.setStart(a.target.firstChild,d),p.setEnd(a.target.firstChild,d);var y=t.getSelection();y.removeAllRanges(),y.addRange(p)}};var c=new Array;return n.init=function(e){var t=a(o,e||{});t.targetId=e.target,t.menuId=e.menu,t.target=document.querySelector(e.target),t.menu=document.querySelector(e.menu),c.push(t),".atm-item"==t.items&&function(e){for(var t=e.menu.children,n=0;n<t.length;n++)t[n].classList.add("atm-item")}(t),null!=t.onChoose&&function(e){var t=document.querySelectorAll(e.items);[].forEach.call(t,(function(t){t.setAttribute("onclick","AtMenu.onChooseRun('"+e.targetId+"', this)")}))}(t),t.target.addEventListener("input",(function(e){!function(e,t){let n,o;if("INPUT"==e.target.tagName||"TEXTAREA"==e.target.tagName?(n=e.target.value,o=e.target.selectionStart):e.target.getAttribute("contenteditable")&&(n=e.target.innerText,o=s(e.target)),n[o-1]===e.openMenu||e.openMenu.indexOf(n[o-1])>-1){var a=AtMenu.getCaretPosition(e);e.marginTop&&e.marginTop,e.menu.style.top=a.caret.top+a.target.top+a.html+"px",e.menu.style.left=a.caret.left+a.target.left-30+"px",e.menu.classList.add("atm-menu-active"),null!=e.onOpen&&AtMenu.onOpenRun(e)}}(t),function(e,t){var n=i(e);null!=n&&(u(n,e,t),null!=e.onFilter&&n.length>0&&AtMenu.onFilterRun(e))}(t,e)}),!1),t.target.addEventListener("keydown",(function(e){t.menu.classList.contains("atm-menu-active")&&(function(e,t){t.code==e.closeMenu&&(e.menu.classList.remove("atm-menu-active"),null!=e.onClose&&AtMenu.onCloseRun(e))}(t,e),function(e,t){null!=e.onChoose&&(13!=t.keyCode&&"Enter"!=t.key&&"insertLineBreak"!=t.inputType||(t.preventDefault(),console.log(e),AtMenu.onChooseRun(e)))}(t,e),function(e,t){if(8==t.keyCode||"Backspace"==t.key){const t=e.target.value,n=e.target.selectionStart;(t[n-1]===e.openMenu||e.openMenu.indexOf(t[n-1])>-1)&&r(e)}}(t,e),function(e,t){if(38==t.keyCode||"ArrowUp"==t.key){t.preventDefault();var n=document.querySelector(e.menuId+" .atm-item-active");if(n){for(var o=n.previousElementSibling;o&&o.classList.contains("atm-item-inactive");)o=o.previousElementSibling;o&&(n.classList.remove("atm-item-active"),o.classList.add("atm-item-active"))}l(e)}}(t,e),function(e,t){if(40==t.keyCode||"ArrowDown"==t.key){t.preventDefault();var n=document.querySelector(e.menuId+" .atm-item-active");if(n){for(var o=n.nextElementSibling;o&&o.classList.contains("atm-item-inactive");)o=o.nextElementSibling;o&&(n.classList.remove("atm-item-active"),o.classList.add("atm-item-active"))}l(e)}}(t,e))}),!1)},n}));