/*
 * At Menu
 * Copyright 2023 Daniel Boothman
 * www.atmenujs.com
 * License: MIT
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t(e)):"object"==typeof exports?module.exports=t(e):e.AtMenu=t(e)}("undefined"!=typeof global?global:this.window||this.global,(function(e){"use strict";var t=e,n={},o={target:"",menu:"",items:".atm-item",openMenu:"@",closeMenu:"Escape",marginTop:0},l=function(){var e={},t=!1,n=0,o=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(t=arguments[0],n++);for(var r=function(n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t&&"[object Object]"===Object.prototype.toString.call(n[o])?e[o]=l(!0,e[o],n[o]):e[o]=n[o])};n<o;n++){r(arguments[n])}return e},r=function(e){e.menu.classList.remove("atm-menu-active"),null!=e.onClose&&AtMenu.onCloseRun(e)},i=function(e){var t=document.querySelector(e.menuId+" .atm-item-active");if(t){var n=t.offsetTop;e.menu.scrollTo({top:n})}},a=function(e){var t=null;const n=e.target.value,o=n.indexOf(e.openMenu);if(o>=0){const l=e.target.selectionStart;t=n.substring(o+1,l)}return t},u=function(e,t,n){var o=document.querySelectorAll(t.menuId+" "+t.items),l=!1,r=document.querySelector(t.menuId+" .atm-item-active");null!=r&&r.classList.remove("atm-item-active");for(var a=0;a<o.length;a++){o[a].innerText.toLowerCase().includes(e.toLowerCase())?(o[a].classList.remove("atm-item-inactive"),0==l&&(l=!0,o[a].classList.add("atm-item-active"))):o[a].classList.add("atm-item-inactive")}0==l&&null!=r&&r.classList.remove("atm-item-active"),i(t)};n.getCaretPosition=function(e){return{caret:s(e.target),target:e.target.getBoundingClientRect(),menu:e.menu.getBoundingClientRect(),html:document.querySelector("html").scrollTop}};var s=function(e){const n=document.createElement("span");n.style.position="absolute",n.style.visibility="hidden",n.style.whiteSpace="pre",n.style.font=t.getComputedStyle(e,null).getPropertyValue("font"),n.style.fontSize=t.getComputedStyle(e,null).getPropertyValue("font-size"),n.style.padding=t.getComputedStyle(e,null).getPropertyValue("padding"),n.style.margin=t.getComputedStyle(e,null).getPropertyValue("margin"),n.style.boxSizing=t.getComputedStyle(e,null).getPropertyValue("box-sizing"),n.style.wordSpacing=t.getComputedStyle(e,null).getPropertyValue("word-spacing"),n.style.textTransform=t.getComputedStyle(e,null).getPropertyValue("text-transform"),n.style.direction=t.getComputedStyle(e,null).getPropertyValue("direction"),n.style.textIndent=t.getComputedStyle(e,null).getPropertyValue("text-indent"),n.style.lineHeight=t.getComputedStyle(e,null).getPropertyValue("line-height"),n.style.border=t.getComputedStyle(e,null).getPropertyValue("border"),n.style.letterSpacing=t.getComputedStyle(e,null).getPropertyValue("letter-spacing"),n.style.fontWeight=t.getComputedStyle(e,null).getPropertyValue("font-weight"),n.style.fontStyle=t.getComputedStyle(e,null).getPropertyValue("font-style"),n.style.fontVariant=t.getComputedStyle(e,null).getPropertyValue("font-variant"),n.style.textDecoration=t.getComputedStyle(e,null).getPropertyValue("text-decoration"),n.style.top=t.getComputedStyle(e,null).getPropertyValue("top"),n.style.left=t.getComputedStyle(e,null).getPropertyValue("left"),n.style.height="auto",n.style.width="auto";const o=e.selectionStart,l=e.value.substring(0,o).split("\n"),r=l[l.length-1];n.textContent=r,document.body.appendChild(n);const i=n.offsetWidth;document.body.removeChild(n);const a=parseFloat(t.getComputedStyle(e,null).getPropertyValue("line-height")),u=parseFloat(t.getComputedStyle(e,null).getPropertyValue("font-size"));return{left:i,top:(l.length-1)*a+a+u}};n.onChooseRun=function(e,t){if("object"!=typeof(o=e)||null===o||Array.isArray(o)){e=c.find((t=>t.targetId==e));var n=t}else n=e.menu.querySelector(".atm-item-active");var o,l={settings:e,event:event,target:e.target,selectedItem:n,typedText:a(e),caretPos:this.getCaretPosition(e)};e.onChoose(l)},n.onOpenRun=function(e){var t={settings:e,event:event,target:e.target,typedText:a(e),caretPos:this.getCaretPosition(e)};e.onOpen(t)},n.onCloseRun=function(e){var t={settings:e,event:event,target:e.target,typedText:a(e),caretPos:this.getCaretPosition(e)};e.onClose(t)},n.onFilterRun=function(e){var t={settings:e,event:event,target:e.target,typedText:a(e),caretPos:this.getCaretPosition(e)};e.onFilter(t)},n.insertContent=function(e,t,n=!0){var o=e.settings,l=o.target.value;const i=l.indexOf(o.openMenu),a=o.target.selectionStart,u=`${t}`,s=a-i,c=l.substring(0,i)+u+l.substring(a);o.target.value=c,r(o);let g=a-s+u.length;o.target.focus(),o.target.setSelectionRange(g,g)};var c=new Array;return n.init=function(e){var t=l(o,e||{});t.targetId=e.target,t.menuId=e.menu,t.target=document.querySelector(e.target),t.menu=document.querySelector(e.menu),c.push(t),".atm-item"==t.items&&function(e){for(var t=e.menu.children,n=0;n<t.length;n++)t[n].classList.add("atm-item")}(t),null!=t.onChoose&&function(e){var t=document.querySelectorAll(e.items);[].forEach.call(t,(function(t){t.setAttribute("onclick","AtMenu.onChooseRun('"+e.targetId+"', this)")}))}(t),t.target.addEventListener("input",(function(e){!function(e,t){if(e.target.value[e.target.selectionStart-1]===e.openMenu){var n=AtMenu.getCaretPosition(e);e.marginTop&&e.marginTop,e.menu.style.top=n.caret.top+n.target.top+n.html+"px",e.menu.style.left=n.caret.left+n.target.left-30+"px",e.menu.classList.add("atm-menu-active"),null!=e.onOpen&&AtMenu.onOpenRun(e)}}(t),function(e,t){var n=a(e);null!=n&&(u(n,e,t),null!=e.onFilter&&n.length>0&&AtMenu.onFilterRun(e))}(t,e)}),!1),t.target.addEventListener("keydown",(function(e){t.menu.classList.contains("atm-menu-active")&&(function(e,t){t.code==e.closeMenu&&(e.menu.classList.remove("atm-menu-active"),null!=e.onClose&&AtMenu.onCloseRun(e))}(t,e),function(e,t){null!=e.onChoose&&(13!=t.keyCode&&"Enter"!=t.key&&"insertLineBreak"!=t.inputType||(t.preventDefault(),console.log(e),AtMenu.onChooseRun(e)))}(t,e),function(e,t){8!=t.keyCode&&"Backspace"!=t.key||e.target.value[e.target.selectionStart-1]===e.openMenu&&r(e)}(t,e),function(e,t){if(38==t.keyCode||"ArrowUp"==t.key){t.preventDefault();var n=document.querySelector(e.menuId+" .atm-item-active");if(n){for(var o=n.previousElementSibling;o&&o.classList.contains("atm-item-inactive");)o=o.previousElementSibling;o&&(n.classList.remove("atm-item-active"),o.classList.add("atm-item-active"))}i(e)}}(t,e),function(e,t){if(40==t.keyCode||"ArrowDown"==t.key){t.preventDefault();var n=document.querySelector(e.menuId+" .atm-item-active");if(n){for(var o=n.nextElementSibling;o&&o.classList.contains("atm-item-inactive");)o=o.nextElementSibling;o&&(n.classList.remove("atm-item-active"),o.classList.add("atm-item-active"))}i(e)}}(t,e))}),!1)},n}));