/*
 * @ Menu
 * Copyright 2023 Daniel Boothman
 * www.atmenujs.com
 * License: MIT
 */
!function(t,e){"function"==typeof define&&define.amd?define([],e(t)):"object"==typeof exports?module.exports=e(t):t.AtMenu=e(t)}("undefined"!=typeof global?global:this.window||this.global,(function(t){"use strict";var e=t,n={},o={target:"",menu:"",items:".atm-item",openMenu:"@",closeMenu:"Escape",marginTop:0},a=function(){var t={},e=!1,n=0,o=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(e=arguments[0],n++);for(var r=function(n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e&&"[object Object]"===Object.prototype.toString.call(n[o])?t[o]=a(!0,t[o],n[o]):t[o]=n[o])};n<o;n++){r(arguments[n])}return t},r=function(t){t.menu.classList.remove("atm-menu-active"),null!=t.onClose&&AtMenu.onCloseRun(t)},l=function(t){var e=document.querySelector(t.menuId+" .atm-item-active");if(e){var n=e.offsetTop;t.menu.scrollTo({top:n})}},i=function(t){var e=null;let n;"INPUT"==t.target.tagName||"TEXTAREA"==t.target.tagName?n=t.target.value:t.target.getAttribute("contenteditable")&&(n=t.target.innerText);const o=n.indexOf(t.openMenu);if(o>=0){let a;"INPUT"==t.target.tagName||"TEXTAREA"==t.target.tagName?a=t.target.selectionStart:t.target.getAttribute("contenteditable")&&(a=s(t.target)),e=n.substring(o+1,a)}return e},u=function(t,e,n){var o=document.querySelectorAll(e.menuId+" "+e.items),a=!1,r=document.querySelector(e.menuId+" .atm-item-active");null!=r&&r.classList.remove("atm-item-active");for(var i=0;i<o.length;i++){o[i].innerText.toLowerCase().includes(t.toLowerCase())?(o[i].classList.remove("atm-item-inactive"),0==a&&(a=!0,o[i].classList.add("atm-item-active"))):o[i].classList.add("atm-item-inactive")}0==a&&null!=r&&r.classList.remove("atm-item-active"),l(e)},s=function(t){let n=0;if(void 0!==e.getSelection){if(0!==e.getSelection().rangeCount){const o=e.getSelection().getRangeAt(0),a=o.cloneRange();a.selectNodeContents(t),a.setEnd(o.endContainer,o.endOffset),n=a.toString().length}}return n};n.getCaretPosition=function(t){return{caret:g(t.target),target:t.target.getBoundingClientRect(),menu:t.menu.getBoundingClientRect(),html:document.querySelector("html").scrollTop}};var g=function(t){const n=document.createElement("span");let o,a;n.style.position="absolute",n.style.visibility="hidden",n.style.whiteSpace="pre",n.style.font=e.getComputedStyle(t,null).getPropertyValue("font"),n.style.fontSize=e.getComputedStyle(t,null).getPropertyValue("font-size"),n.style.padding=e.getComputedStyle(t,null).getPropertyValue("padding"),n.style.margin=e.getComputedStyle(t,null).getPropertyValue("margin"),n.style.boxSizing=e.getComputedStyle(t,null).getPropertyValue("box-sizing"),n.style.wordSpacing=e.getComputedStyle(t,null).getPropertyValue("word-spacing"),n.style.textTransform=e.getComputedStyle(t,null).getPropertyValue("text-transform"),n.style.direction=e.getComputedStyle(t,null).getPropertyValue("direction"),n.style.textIndent=e.getComputedStyle(t,null).getPropertyValue("text-indent"),n.style.lineHeight=e.getComputedStyle(t,null).getPropertyValue("line-height"),n.style.border=e.getComputedStyle(t,null).getPropertyValue("border"),n.style.letterSpacing=e.getComputedStyle(t,null).getPropertyValue("letter-spacing"),n.style.fontWeight=e.getComputedStyle(t,null).getPropertyValue("font-weight"),n.style.fontStyle=e.getComputedStyle(t,null).getPropertyValue("font-style"),n.style.fontVariant=e.getComputedStyle(t,null).getPropertyValue("font-variant"),n.style.textDecoration=e.getComputedStyle(t,null).getPropertyValue("text-decoration"),n.style.top=e.getComputedStyle(t,null).getPropertyValue("top"),n.style.left=e.getComputedStyle(t,null).getPropertyValue("left"),n.style.height="auto",n.style.width="auto","INPUT"==t.tagName||"TEXTAREA"==t.tagName?(o=t.selectionStart,a=t.value.substring(0,o).split("\n")):t.getAttribute("contenteditable")&&(o=s(t),a=t.innerText.substring(0,o).split("\n"));const r=a[a.length-1];n.textContent=r,document.body.appendChild(n);const l=n.offsetWidth;document.body.removeChild(n);const i=parseFloat(e.getComputedStyle(t,null).getPropertyValue("line-height")),u=parseFloat(e.getComputedStyle(t,null).getPropertyValue("font-size"));return{left:l,top:(a.length-1)*i+i+u}};n.onChooseRun=function(t,e){if("object"!=typeof(o=t)||null===o||Array.isArray(o)){t=c.find((e=>e.targetId==t));var n=e}else n=t.menu.querySelector(".atm-item-active");var o,a={settings:t,event:event,target:t.target,selectedItem:n,typedText:i(t),caretPos:this.getCaretPosition(t)};t.onChoose(a)},n.onOpenRun=function(t){var e={settings:t,event:event,target:t.target,typedText:i(t),caretPos:this.getCaretPosition(t)};t.onOpen(e)},n.onCloseRun=function(t){var e={settings:t,event:event,target:t.target,typedText:i(t),caretPos:this.getCaretPosition(t)};t.onClose(e)},n.onFilterRun=function(t){var e={settings:t,event:event,target:t.target,typedText:i(t),caretPos:this.getCaretPosition(t)};t.onFilter(e)},n.insertContent=function(t,n,o=!0){var a=t.settings;let l,i;"INPUT"==a.target.tagName||"TEXTAREA"==a.target.tagName?(l=a.target.value,i=a.target.selectionStart):a.target.getAttribute("contenteditable")&&(l=a.target.innerText,i=s(a.target));const u=l.indexOf(a.openMenu),g=`${n}`,c=i-u,m=l.substring(0,u)+g+l.substring(i);"INPUT"==a.target.tagName||"TEXTAREA"==a.target.tagName?a.target.value=m:a.target.innerText=m,r(a);let d=i-c+g.length;if(a.target.focus(),"INPUT"==a.target.tagName||"TEXTAREA"==a.target.tagName)a.target.setSelectionRange(d,d);else if(a.target.getAttribute("contenteditable")){var p=document.createRange();p.setStart(a.target.firstChild,d),p.setEnd(a.target.firstChild,d);var y=e.getSelection();y.removeAllRanges(),y.addRange(p)}};var c=new Array;return n.init=function(t){var e=a(o,t||{});e.targetId=t.target,e.menuId=t.menu,e.target=document.querySelector(t.target),e.menu=document.querySelector(t.menu),c.push(e),".atm-item"==e.items&&function(t){for(var e=t.menu.children,n=0;n<e.length;n++)e[n].classList.add("atm-item")}(e),null!=e.onChoose&&function(t){var e=document.querySelectorAll(t.items);[].forEach.call(e,(function(e){e.setAttribute("onclick","AtMenu.onChooseRun('"+t.targetId+"', this)")}))}(e),e.target.addEventListener("input",(function(t){!function(t,e){let n,o;if("INPUT"==t.target.tagName||"TEXTAREA"==t.target.tagName?(n=t.target.value,o=t.target.selectionStart):t.target.getAttribute("contenteditable")&&(n=t.target.innerText,o=s(t.target)),n[o-1]===t.openMenu){var a=AtMenu.getCaretPosition(t);t.marginTop&&t.marginTop,t.menu.style.top=a.caret.top+a.target.top+a.html+"px",t.menu.style.left=a.caret.left+a.target.left-30+"px",t.menu.classList.add("atm-menu-active"),null!=t.onOpen&&AtMenu.onOpenRun(t)}}(e),function(t,e){var n=i(t);null!=n&&(u(n,t,e),null!=t.onFilter&&n.length>0&&AtMenu.onFilterRun(t))}(e,t)}),!1),e.target.addEventListener("keydown",(function(t){e.menu.classList.contains("atm-menu-active")&&(function(t,e){e.code==t.closeMenu&&(t.menu.classList.remove("atm-menu-active"),null!=t.onClose&&AtMenu.onCloseRun(t))}(e,t),function(t,e){null!=t.onChoose&&(13!=e.keyCode&&"Enter"!=e.key&&"insertLineBreak"!=e.inputType||(e.preventDefault(),console.log(t),AtMenu.onChooseRun(t)))}(e,t),function(t,e){8!=e.keyCode&&"Backspace"!=e.key||t.target.value[t.target.selectionStart-1]===t.openMenu&&r(t)}(e,t),function(t,e){if(38==e.keyCode||"ArrowUp"==e.key){e.preventDefault();var n=document.querySelector(t.menuId+" .atm-item-active");if(n){for(var o=n.previousElementSibling;o&&o.classList.contains("atm-item-inactive");)o=o.previousElementSibling;o&&(n.classList.remove("atm-item-active"),o.classList.add("atm-item-active"))}l(t)}}(e,t),function(t,e){if(40==e.keyCode||"ArrowDown"==e.key){e.preventDefault();var n=document.querySelector(t.menuId+" .atm-item-active");if(n){for(var o=n.nextElementSibling;o&&o.classList.contains("atm-item-inactive");)o=o.nextElementSibling;o&&(n.classList.remove("atm-item-active"),o.classList.add("atm-item-active"))}l(t)}}(e,t))}),!1)},n}));